<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Sometimes authentication with a username and password is not secure enough. A login form might contain vulnerabilities or give away important information, like what software you are running on the given domain (and what version of it). Client certificate authorization is just like using SSH: your client has a private and public key installed that it uses to let the server know it can be trusted (through mutual TLS). It&rsquo;s not very user friendly, but it IS a great way to secure your web app."><meta name=theme-color content="#ec7067"><meta property="og:title" content="Client certificate authentication with Traefik • Nerdieworks"><meta property="og:description" content="Sometimes authentication with a username and password is not secure enough. A login form might contain vulnerabilities or give away important information, like what software you are running on the given domain (and what version of it). Client certificate authorization is just like using SSH: your client has a private and public key installed that it uses to let the server know it can be trusted (through mutual TLS). It&rsquo;s not very user friendly, but it IS a great way to secure your web app."><meta property="og:url" content="https://nerdieworks.nl/posts/client-certificate-authentication-with-traefik/"><meta property="og:site_name" content="Nerdieworks"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:tag" content="traefik"><meta property="article:tag" content="tutorial"><meta property="article:tag" content="snippet"><meta property="article:tag" content="security"><meta property="article:published_time" content="2022-06-27T21:15:17+02:00"><meta property="article:modified_time" content="2022-06-27T21:15:17+02:00"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.100.1"><title>Client certificate authentication with Traefik • Nerdieworks</title><link rel=canonical href=https://nerdieworks.nl/posts/client-certificate-authentication-with-traefik/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#ec7067}</style></head><body class='page type-posts has-sidebar'><div class=site><div id=sidebar class=sidebar><a class=screen-reader-text href=#main-menu>Skip to Main Menu</a><div class=container><section class='widget widget-about sep-after'><header><div class=logo><a href=/><img src=/images/logo.png></a></div><h2 class='title site-title'><a href=/>Nerdieworks</a></h2><div class=desc>DevOps babble</div></header></section><section class='widget widget-sidebar_menu sep-after'><nav id=sidebar-menu class='menu sidebar-menu' aria-label='Sidebar Menu'><div class=container><ul><li class=item><a href=/>Home</a></li><li class='item has-current'><a href=/posts/>Posts</a></li></ul></div></nav></section><section class='widget widget-taxonomy_cloud sep-after'><header><h4 class='title widget-title'>Tags</h4></header><div class='container list-container'><ul class='list taxonomy-cloud'><li><a href=/tags/security/ style=font-size:1em>security</a></li><li><a href=/tags/snippet/ style=font-size:2em>snippet</a></li><li><a href=/tags/traefik/ style=font-size:2em>traefik</a></li><li><a href=/tags/tutorial/ style=font-size:2em>tutorial</a></li></ul></div></section></div><div class=sidebar-overlay></div></div><div class=main><a class=screen-reader-text href=#content>Skip to Content</a>
<button id=sidebar-toggler class=sidebar-toggler aria-controls=sidebar>
<span class=screen-reader-text>Toggle Sidebar</span>
<span class=open><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></span><span class=close><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span></button><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class='widget widget-breadcrumbs sep-after'><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/posts/>Posts</a></li><li><span>Client certificate authentication with Traefik</span></li></ol></nav></section></div></div><header id=header class='header site-header'><div class='container sep-after'><div class=header-info><p class='site-title title'>Nerdieworks</p><p class='desc site-desc'>DevOps babble</p></div></div></header><main id=content><article lang=en class=entry><header class='header entry-header'><div class='container sep-after'><div class=header-info><h1 class=title>Client certificate authentication with Traefik</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2022-06-27T21:15:17+02:00>2022, June 27</time></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>3 mins read</span></div></div></header><div class='container entry-content'><p>Sometimes authentication with a username and password is not secure enough. A login form might contain vulnerabilities or give away important information, like what software you are running on the given domain (and what version of it). <strong>Client certificate authorization</strong> is just like using SSH: your client has a private and public key installed that it uses to let the server know it can be trusted (through <a href=https://www.cloudflare.com/en-gb/learning/access-management/what-is-mutual-tls/>mutual TLS</a>). It&rsquo;s not very user friendly, but it IS a great way to secure your web app.</p><p>Doing this with <a href=https://doc.traefik.io/traefik/>Traefik</a> is fairly straightforward:</p><ol><li>Generate a certificate authority (CA)</li><li>Add the CA certificate to Traefik</li><li>Create an <a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/>IngressRoute</a> that uses the CA certificate</li><li>Generate a client certificate</li><li>Install the client certificate on your client(s)</li></ol><h2 id=1-generate-a-certificate-authority-ca>1. Generate a certificate authority (CA)</h2><p>Generate the CA certificate with the <code>openssl</code> command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>openssl genrsa -des3 -out <span style=color:#e6db74>&#39;ca.key&#39;</span> <span style=color:#ae81ff>4096</span>
</span></span><span style=display:flex><span>openssl req -x509 -new -nodes -key <span style=color:#e6db74>&#39;ca.key&#39;</span> -sha384 -days <span style=color:#ae81ff>1825</span> -out <span style=color:#e6db74>&#39;ca.crt&#39;</span>
</span></span></code></pre></div><p><strong>Important:</strong> store the <code>ca.key</code> in a secure place.</p><p>Next, create a <code>Secret</code> in the same namespace where the <code>IngressRoute</code> will be in:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create secret generic <span style=color:#e6db74>&#39;client-auth-ca-cert&#39;</span> -n <span style=color:#e6db74>&#39;my-namespace&#39;</span> --from-file<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ca.crt=ca.crt&#39;</span>
</span></span></code></pre></div><p>Make sure the key is either <code>ca.crt</code> or <code>tls.ca</code>. See the <a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-crd/#kind-tlsoption>TLSOption documentation</a> for more info.</p><h2 id=2-add-the-ca-certificate-to-traefik>2. Add the CA certificate to Traefik</h2><p>Create a <code>TLSOption</code> in the same namespace as the <code>Secret</code> that we have created in the previous step:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>traefik.containo.us/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>TLSOption</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>client-cert</span> <span style=color:#75715e># Change this</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>my-namespace</span> <span style=color:#75715e># Change this</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>minVersion</span>: <span style=color:#ae81ff>VersionTLS12</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>maxVersion</span>: <span style=color:#ae81ff>VersionTLS13</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>clientAuth</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>secretNames</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>client-auth-ca-cert</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>clientAuthType</span>: <span style=color:#ae81ff>RequireAndVerifyClientCert</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>curvePreferences</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>CurveP521</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>CurveP384</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>cipherSuites</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>TLS_AES_256_GCM_SHA384</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>TLS_CHACHA20_POLY1305_SHA256</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>sniStrict</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>At this point the CA certificate is ready to use.</p><h2 id=3-create-an-ingressroute-that-uses-the-ca-certificate>3. Create an IngressRoute that uses the CA certificate</h2><p>Use the following snippet. Make changes where necessary.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>traefik.containo.us/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>IngressRoute</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>example-com</span> <span style=color:#75715e># Change this</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>my-namespace</span> <span style=color:#75715e># Change this</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>entryPoints</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>websecure</span> <span style=color:#75715e># Change this?</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>routes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Rule</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>match</span>: <span style=color:#e6db74>&#34;Host(`example.com`)&#34;</span> <span style=color:#75715e># Change this</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># You can use this service for testing. It will respond with a &#39;418 I&#39;m a teapot&#39;</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>TraefikService</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>noop@internal</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tls</span>: <span style=color:#75715e># Not merged with static configuration</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># certResolver: letsencrypt # You can add this later</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>options</span>:
</span></span><span style=display:flex><span>      <span style=color:#75715e># Change these. Must match the metadata from step 2</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>client-cert</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>my-namespace</span>
</span></span></code></pre></div><p>Once created, try <code>curl -vk https://example.com --resolve example.com:443:{server IP}</code>. It should respond with a <code>bad certificate</code> error.</p><h2 id=4-generate-a-client-certificate>4. Generate a client certificate</h2><p>Now that everything is set up on the server side, we can create a client key and certificate:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export DOMAIN<span style=color:#f92672>=</span>example.com <span style=color:#75715e># Same as Host in IngressRoute&#39;s match</span>
</span></span><span style=display:flex><span>export ORGANIZATION<span style=color:#f92672>=</span>Example
</span></span><span style=display:flex><span>export COUNTRY<span style=color:#f92672>=</span>NL
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>openssl genrsa -des3 -out <span style=color:#e6db74>&#34;</span>$DOMAIN<span style=color:#e6db74>.key&#34;</span> <span style=color:#ae81ff>4096</span>
</span></span><span style=display:flex><span>openssl req -new -key <span style=color:#e6db74>&#34;</span>$DOMAIN<span style=color:#e6db74>.key&#34;</span> -out <span style=color:#e6db74>&#34;</span>$DOMAIN<span style=color:#e6db74>.csr&#34;</span> -subj <span style=color:#e6db74>&#34;/CN=</span>$DOMAIN<span style=color:#e6db74>/O=</span>$ORGANIZATION<span style=color:#e6db74>/C=</span>$COUNTRY<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Use ca.crt and ca.key from step 1</span>
</span></span><span style=display:flex><span>openssl x509 -sha384 -req -CA <span style=color:#e6db74>&#39;ca.crt&#39;</span> -CAkey <span style=color:#e6db74>&#39;ca.key&#39;</span> -CAcreateserial -days <span style=color:#ae81ff>365</span> -in <span style=color:#e6db74>&#34;</span>$DOMAIN<span style=color:#e6db74>.csr&#34;</span> -out <span style=color:#e6db74>&#34;</span>$DOMAIN<span style=color:#e6db74>.crt&#34;</span>
</span></span><span style=display:flex><span>openssl pkcs12 -export -out <span style=color:#e6db74>&#34;</span>$DOMAIN<span style=color:#e6db74>.pfx&#34;</span> -inkey <span style=color:#e6db74>&#34;</span>$DOMAIN<span style=color:#e6db74>.key&#34;</span> -in <span style=color:#e6db74>&#34;</span>$DOMAIN<span style=color:#e6db74>.crt&#34;</span>
</span></span></code></pre></div><p>Let&rsquo;s try out the certificate:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -vk https://example.com --resolve example.com:443:<span style=color:#f92672>{</span>server IP<span style=color:#f92672>}</span> --cert <span style=color:#e6db74>&#34;</span>$DOMAIN<span style=color:#e6db74>.crt&#34;</span> --key <span style=color:#e6db74>&#34;</span>$DOMAIN<span style=color:#e6db74>.key&#34;</span>
</span></span></code></pre></div><p>The server should now respond with a <code>418 I'm a teapot</code>.</p><h2 id=5-install-the-client-certificate-on-your-clients>5. Install the client certificate on your client(s)</h2><p>Most clients support a way to add a client certificate. The best way to figure out how is to <a href="https://duckduckgo.com/?q=install+client+certificate+firefox">do a quick online search</a>. Here are some examples:</p><ul><li>Add to <strong>Firefox</strong>: Settings > Privacy & Security > View Certificates > Your Certificates > Import.</li><li>Add to <strong>Android</strong>: Settings > Security > Advanced > Encryption & Credentials > Install from SD card (tested in Chrome).</li><li>Add to Firefox on Android: didn&rsquo;t get it to work, despite trying <a href=https://blog.jeroenhd.nl/article/firefox-for-android-using-a-custom-certificate-authority>https://blog.jeroenhd.nl/article/firefox-for-android-using-a-custom-certificate-authority</a>.</li></ul><p>When connecting to your domain for the first time, the client usually shows a popup to select the installed client certificate.</p><p>That&rsquo;s it. You have now established a very secure connection with your server. Just make sure you don&rsquo;t leak one of your private key files!</p></div><footer class=entry-footer><div class='container sep-before'><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/traefik/>traefik</a>, <a class=tag href=/tags/tutorial/>tutorial</a>, <a class=tag href=/tags/snippet/>snippet</a>, <a class=tag href=/tags/security/>security</a></div></div></footer></article><nav class=entry-nav><div class=container><div class='prev-entry sep-before'><a href=/posts/traefik-add-trailing-slash/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>Traefik: add trailing slash</a></div></div></nav><section id=comments class=comments><div class='container sep-before'><div class=comments-area><script src=https://utteranc.es/client.js repo=Nerdieworks/nerdieworks.nl issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></section></main><footer id=footer class=footer><div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'><ul><li><a href=https://github.com/Nerdieworks target=_blank rel='noopener me'><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=mailto:maurits@nerdieworks.nl target=_blank rel='noopener me'><span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://linkedin.com/in/mauritsvanmastrigt target=_blank rel='noopener me'><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li><li><a href=https://t.me/mauvm target=_blank rel='noopener me'><span class=screen-reader-text>Open Telegram account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M23.91 3.79 20.3 20.84c-.25 1.21-.98 1.5-2 .94l-5.5-4.07-2.66 2.57c-.3.3-.55.56-1.1.56-.72.0-.6-.27-.84-.95L6.3 13.7.85 12c-1.18-.35-1.19-1.16.26-1.75l21.26-8.2c.97-.43 1.9.24 1.53 1.73z"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2019-2022 Maurits van Mastrigt</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script></body></html>